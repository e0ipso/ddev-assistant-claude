ARG BASE_IMAGE
FROM $BASE_IMAGE

# Pre-install Claude Code to /usr/local/lib/claude/claude.
# This path is outside the web user's home, which DDEV mounts as a Docker named volume
# at runtime â€” files placed under the home directory in the image layer would be masked.
# A post-start hook (config.assistant-claude.yaml) copies the binary into
# ~/.local/bin/claude on first start so it is user-owned and on the volume.
# Using cp -L dereferences any symlinks before copying, which prevents a broken
# symlink at the destination when the installer uses relative symlinks internally.
RUN curl -fsSL https://claude.ai/install.sh | bash && \
    mkdir -p /usr/local/lib/claude && \
    cp -L /root/.local/bin/claude /usr/local/lib/claude/claude && \
    chmod 755 /usr/local/lib/claude/claude

# Ensure ~/.local/bin is in PATH for non-interactive shells (ddev exec).
# BASH_ENV is sourced by bash for non-interactive shells, which is how `ddev exec`
# runs commands (e.g. `bash -c "claude --version"`).  Using $HOME means this works
# regardless of which user DDEV maps into the container at runtime.
# Interactive shells (ddev ssh) are covered by a ~/.bashrc.d script created in the
# post-start hook (config.assistant-claude.yaml), since the home directory is a
# volume and cannot be populated at build time.
RUN printf 'export PATH="$HOME/.local/bin:$PATH"\n' > /etc/bash.env
ENV BASH_ENV=/etc/bash.env
